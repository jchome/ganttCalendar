/*
 * Gantt Calendar by Julien CORON - 2013
 * Copyright 2013 Julien CORON
 * 
 * Licence :
   Ce programme est un logiciel libre ; vous pouvez le redistribuer ou le 
   modifier suivant les termes de la GNU General Public License telle que 
   publiée par la Free Software Foundation ; soit la version 3 de la licence, 
   soit (à votre gré) toute version ultérieure.

   Ce programme est distribué dans l'espoir qu'il sera utile, mais SANS AUCUNE 
   GARANTIE ; pas même la garantie implicite de COMMERCIABILISABILITÉ ni 
   d'ADÉQUATION à UN OBJECTIF PARTICULIER. Consultez la GNU General Public 
   License pour plus de détails.
 * 
 * 
   This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

TimeLine=function(e,t,s,i,r){var n=this.init(e,t,s,i,r);return $(window).resize(function(){n.drawElements(),n.updateCallback(),this.updateOccupation()}),n},$.extend(TimeLine.prototype,{TimeLineClass:null,container:"",year:"",lang:"fr",weekDays:{fr:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],en:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},months:{fr:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Décembre"],en:["January","February","March","April","May","June","July","Agust","September","October","November","December"]},resourcesColumnHeader:{fr:"Ressources",en:"Resources"},days:{1:[31,31],2:[28,29],3:[31,31],4:[30,30],5:[31,31],6:[30,30],7:[31,31],8:[31,31],9:[30,30],10:[31,31],11:[30,30],12:[31,31]},eventsByGroup:{},eventsByResource:{},cellWidth:20,_superInit:function(e,t,s,i){this.container=e,this.year=t,this.resources=s,this.updateCallback=i||function(){}},init:function(e,t,s,i,r){return this._superInit(e,s,i,r),this.sub_init(t),this},sub_init:function(){},nbDays:function(){return 0},nbSteps:function(){return 0},firstDay:function(){return 0},findGroupHavingResource:function(e){for(var t=0;t<this.resources.groups.length;t++)for(var s=this.resources.groups[t],i=0;i<s.resources.length;i++){var r=s.resources[i];if(r.id==e)return s}return null},_drawResourcesIn:function(e,t){for(null==t&&(t=!1),calendarHeaders=$(document.createElement("div")).addClass("leftColumn horizontalCalendarHeaders"),e.append(calendarHeaders),headerResources=$(document.createElement("div")).addClass("headerResources"),calendarHeaders.html(headerResources),listResources=$(document.createElement("div")).addClass("listResources"),calendarHeaders.append(listResources),indexGroup=0;indexGroup<this.resources.groups.length;indexGroup++)for(group=this.resources.groups[indexGroup],listResources.append('<div id="group_'+group.id+'_left" class="group_left" data-group="'+group.id+'">					<span class="toggleImg">&#9660;</span><span class="labelLeft">'+group.name+"</span>				</div>"),groupResources=$(document.createElement("div")).addClass("resourcesForGroup").attr("id","resourcesForGroup_"+group.id).data("group",group.id),listResources.append(groupResources),indexResource=0;indexResource<group.resources.length;indexResource++)resource=group.resources[indexResource],groupResources.append('<div id="resource_'+resource.id+'" data-group="group_'+group.id+'" class="resource lineResource">					<span class="labelRight">'+resource.name+"</span>					</div>");return headerResources},_prepareDrawings:function(){return this.eventsByGroup={},this.eventsByResource={},this.containerObj=$("#"+this.container),this.containerObj.timeLineMonth=this,largeCalendar=$(document.createElement("div")).addClass("largeCalendar"),this.containerObj.html(largeCalendar),largeCalendar},_setZoomFeatures:function(e,t,s){this.containerObj.width($("body").outerWidth()-1);var i=this.nbDays();this.cellWidth*i+t.width()+3<this.containerObj.width()&&this.containerObj.width(this.cellWidth*i+t.width()+3);var r=e.width()-t.width()-1;this.cellWidth*i<r&&(r=this.cellWidth*i),s.width(r)},_drawGridEvents:function(e){var t=$(document.createElement("div")).addClass("eventsAndGroupContainer");for(e.append(t),indexGroup=0;indexGroup<this.resources.groups.length;indexGroup++)for(group=this.resources.groups[indexGroup],t.append('<div id="group_'+group.id+'_right"data-group="'+group.id+'" class="group_right">&nbsp;</div>'),groupResources=$(document.createElement("div")).addClass("eventsForGroup").attr("id","eventsForGroup_"+group.id).data("group",group.id),t.append(groupResources),indexResource=0;indexResource<group.resources.length;indexResource++)resource=group.resources[indexResource],groupResources.append('<div class="lineForResource grid-'+this.cellWidth+" offset-"+this.offset()+'" data-resource="resource_'+resource.id+'" id="events_r_'+resource.id+'"></div>')},addEvent:function(e){var t=this.findGroupHavingResource(e.resourceId);null==t&&alert("Error: Event id="+e.eventId+" has an error. Please check resourceId."),null==this.eventsByGroup[t.id]&&(this.eventsByGroup[t.id]=Array()),this.eventsByGroup[t.id].push(e),null==this.eventsByResource[e.resourceId]&&(this.eventsByResource[e.resourceId]=Array()),this.eventsByResource[e.resourceId].push(e)},updateOccupation:function(){for(var e,t,s=this,i=this.nbSteps(),r=0;r<this.resources.groups.length;r++){var n=this.resources.groups[r];if(null!=this.eventsByGroup[n.id]){var a=$("#group_"+n.id+"_right"),o=this.eventsByGroup[n.id],d=$.map(o||[],function(e){return e.asVector(s)});e=Vector.mergeContinuous(d),Vector.flatDisplay(e,a,0,i,"occupationLeak");for(var d=Array(),h=0;h<n.resources.length;h++){var u=n.resources[h],c=this.eventsByResource[u.id],l=$.map(c||[],function(e){return e.asVector(s)});d.push(l)}t=Vector.intersectAll(d),Vector.flatDisplay(t,a,0,i,"occupationFull")}}for(resource_id in this.eventsByResource){var p=0,o=this.eventsByResource[resource_id],d=$.map(o||[],function(e){return e.asVector(s)});if(p=Vector.countOverlaps(d),$("#resource_"+resource_id).addClass("overlap_"+p),$("#events_r_"+resource_id).addClass("overlap_"+p),p>1)for(var m,v=1,f=d[0],y=1;y<d.length;y++)m=f.intersection(d[y]),0!=m.getLength()&&($("#"+o[y].eventId).css("top",1+24*v+"px"),v++)}},closeGroup:function(e){$("#resourcesForGroup_"+e).animate({height:"toggle"}),$("#eventsForGroup_"+e).animate({height:"toggle"});var t=$("#group_"+e+"_left > .toggleImg");t.html("1px"==$("#resourcesForGroup_"+e).css("height")?"&#9660;":"&#9654;")},defineHeader:function(){this.header=this.containerObj.clone().attr("id","headerCalendar"),this.header.find(".listResources").remove(),this.header.find(".eventsAndGroupContainer").remove(),this.header.find(".eventsContainer").removeClass("y-scroll").addClass("no-scroll"),this.header.hide(),this.containerObj.append(this.header)},updateScrollWindow:function(){var e=this.containerObj.offset(),t=$(window).scrollTop(),s=$(".y-scroll").scrollLeft(),i=this.header.height();t>e.top&&t<e.top+this.containerObj.height()-i?(this.header.show(),this.header.css("top",$(window).scrollTop()),$(".no-scroll").scrollLeft(s)):this.header.hide()},sub_defineEvents:function(){},defineEvents:function(){var e=this;$(".prev").click(function(){e.goToPrev(),e.updateScrollWindow()}),$(".next").click(function(){e.goToNext(),e.updateScrollWindow()}),$(".horizontalCalendarContent").keydown(function(t){switch(t.keyCode){case 34:e.goToPrev(),$(".horizontalCalendarContent").focus();break;case 33:e.goToNext(),$(".horizontalCalendarContent").focus()}}),$(".group_left").click(function(){e.closeGroup($(this).attr("data-group"))}),$(window).scroll(function(){e.updateScrollWindow()}),$(".y-scroll").scroll(function(){$(".no-scroll").scrollLeft($(this).scrollLeft())}),this.sub_defineEvents()}}),TimeLineMonth=function(e,t,s,i,r){return this.init(e,t,s,i,r)},TimeLineMonth.prototype=Object.create(TimeLine.prototype),$.extend(TimeLineMonth.prototype,{TimeLineClass:"MONTH",month:"",sub_init:function(e){this.month=e},nbDays:function(){var e=this.year%4==0&&this.year%100!=0||this.year%400==0?1:0;return this.days[this.month][e]},nbSteps:function(){return this.nbDays()-1},offset:function(){return new Date(this.year,this.month-1,1).getDay()},drawElements:function(){var e,t,s,i,r,n,a,o,d,h,e=this._prepareDrawings();t=$(document.createElement("div")).addClass("month"),e.html(t),t.html('<div class="prev" title="[Page down] Go to Previous month"></div>		<div class="nameMonth">'+this.months[this.lang][this.month-1]+" "+this.year+'</div>		<div class="next" title="[Page up] Go to next month"></div>');var i=this._drawResourcesIn(e);for(s=$(document.createElement("div")).addClass("eventsContainer y-scroll container-grid-"+this.cellWidth),e.append(s),this._setZoomFeatures(e,i,s),r=$(document.createElement("span")).addClass("labelCenter").html(this.resourcesColumnHeader[this.lang]),i.html(r),n=$(document.createElement("div")).addClass("horizontalCalendarContent for"+this.nbDays()+"days").attr("tabindex","0"),s.append(n),a=$(document.createElement("div")).addClass("lineOfDays"),n.html(a),o="",d=1;d<=this.nbDays();d++)h=10>d?"0"+d:d,jsDate=new Date(this.year,this.month-1,d),o+='<div class="day weekdayorder_'+jsDate.getDay()+'" id="day_'+h+'">'+h+'<br/><span class="weekDay">'+this.weekDays[this.lang][jsDate.getDay()]+"</span></div>";a.html(o),this._drawGridEvents(n),this.defineHeader(),this.defineEvents(),this.updateCallback(),this.updateOccupation()},goToNext:function(){12==this.month?(this.month=1,this.year++):this.month++,this.drawElements()},goToPrev:function(){1==this.month?(this.month=12,this.year--):this.month--,this.drawElements()},updateWidth:function(){$(".eventsContainer").width($(".largeCalendar").width()-$(".headerResources").width()-1)},sub_defineEvents:function(){}}),TimeLineWeek=function(e,t,s,i,r){return this.init(e,t,s,i,r)},TimeLineWeek.prototype=Object.create(TimeLine.prototype),$.extend(TimeLineWeek.prototype,{TimeLineClass:"WEEK",weekNumber:"",mondayOfWeek:null,sundayOfWeek:null,sub_init:function(e){this.weekNumber=e},dateFormat:function(){var e=this.weekDays[this.lang][1],t=this.weekDays[this.lang][0],s={year:"numeric",month:"2-digit",day:"2-digit"};return e+" "+this.mondayOfWeek.toLocaleDateString(this.lang,s)+" - "+t+" "+this.sundayOfWeek.toLocaleDateString(this.lang,s)},nbDays:function(){return 7},nbSteps:function(){return 13},offset:function(){return new Date(this.mondayOfWeek.getTime()).getDay()},drawElements:function(){var e,t,s,i,r,n,a,o,d,h,u=new Date(this.year,0,1),c=6048e5*(this.weekNumber-1),l=u.getTime()+c-864e5;this.mondayOfWeek=new Date(l),this.sundayOfWeek=new Date(l),this.sundayOfWeek.setDate(this.mondayOfWeek.getDate()+6);var e=this._prepareDrawings();t=$(document.createElement("div")).addClass("week"),e.html(t),t.html('<div class="prev" title="[Page down] Go to Previous week"></div>		<div class="nameWeek"> '+this.dateFormat()+'</div>		<div class="next" title="[Page up] Go to next week"></div>');var i=this._drawResourcesIn(e);s=$(document.createElement("div")).addClass("eventsContainer y-scroll container-grid-"+this.cellWidth+" forWeek"),e.append(s),this._setZoomFeatures(e,i,s),r=$(document.createElement("span")).addClass("labelCenter").html(this.resourcesColumnHeader[this.lang]),i.html(r),n=$(document.createElement("div")).addClass("horizontalCalendarContent").attr("tabindex","0").width(7*this.cellWidth),s.append(n),a=$(document.createElement("div")).addClass("lineOfDays"),n.html(a),o="";var p=new Date(this.mondayOfWeek.getTime());for(d=1;7>=d;d++)h=p.getDate()<10?"0"+p.getDate():p.getDate(),o+='<div class="day weekdayorder_'+p.getDay()+'" id="day_'+h+'">'+h+'<br/><span class="weekDay">'+this.weekDays[this.lang][d%7]+"</span></div>",p.setDate(p.getDate()+1);a.html(o),this._drawGridEvents(n),this.defineHeader(),this.defineEvents(),this.updateCallback(),this.updateOccupation()},goToNext:function(){52==this.weekNumber?(this.weekNumber=1,this.year++):this.weekNumber++,this.drawElements()},goToPrev:function(){1==this.weekNumber?(this.weekNumber=52,this.year--):this.weekNumber--,this.drawElements()},updateWidth:function(){$(".eventsContainer").width($(".largeCalendar").width()-$(".headerResources").width()-1)},sub_defineEvents:function(){}}),TimeLineDay=function(e,t,s,i,r,n){return this.init(e,t,s,i,r,n)},TimeLineDay.prototype=Object.create(TimeLineMonth.prototype),$.extend(TimeLineDay.prototype,{TimeLineClass:"DAY",init:function(e,t,s,i,r,n){return this._superInit(e,i,r,n),this.sub_init(t,s),this},sub_init:function(e,t){this.day=e,this.month=t},nbHours:function(){return 12},startHour:function(){return 8},nbSteps:function(){return this.nbHours()-1},offset:function(){return this.startHour()},_setZoomFeatures:function(e,t,s){this.containerObj.width($("body").outerWidth()-1);var i=this.nbHours();this.cellWidth*i+t.width()+3<this.containerObj.width()&&this.containerObj.width(this.cellWidth*i+t.width()+3);var r=e.width()-t.width()-1;this.cellWidth*i<r&&(r=this.cellWidth*i),s.width(r)},drawElements:function(){var e,t,s,i,r,n,e=this._prepareDrawings();t=$(document.createElement("div")).addClass("day"),e.html(t),jsDate=new Date(this.year,this.month-1,this.day),t.html('<div class="prev" title="[Page down] Go to Previous day"></div>			<div class="nameDay">'+this.weekDays[this.lang][jsDate.getDay()]+" "+this.day+" "+this.months[this.lang][this.month-1]+" "+this.year+'</div>			<div class="next" title="[Page up] Go to next day"></div>');var i=this._drawResourcesIn(e);for(s=$(document.createElement("div")).addClass("eventsContainer y-scroll hourContainer container-grid-"+this.cellWidth),e.append(s),this._setZoomFeatures(e,i,s),r=$(document.createElement("span")).addClass("labelCenter").html(this.resourcesColumnHeader[this.lang]),i.html(r),n=$(document.createElement("div")).addClass("horizontalCalendarContent for"+this.nbHours()+"hours").attr("tabindex","0"),s.append(n),lineOfHours=$(document.createElement("div")).addClass("lineOfHours"),n.html(lineOfHours),htmlHours="",indexHour=this.startHour();indexHour<this.nbHours()+this.startHour();indexHour++)hour2digits=indexHour<10?"0"+indexHour:indexHour,htmlHours+='<div class="hour hourOrder_'+hour2digits+'" id="hour_'+hour2digits+'">'+hour2digits+"h</div>";lineOfHours.html(htmlHours),this._drawGridEvents(n),this.defineHeader(),this.defineEvents(),this.updateCallback(),this.updateOccupation()},sub_defineEvents:function(){},goToNext:function(){this.day++;var e=this.year%4==0&&this.year%100!=0||this.year%400==0?1:0;this.day>this.days[this.month][e]&&(this.day=1,12==this.month?(this.month=1,this.year++):this.month++),this.drawElements()},goToPrev:function(){this.day--;var e=this.year%4==0&&this.year%100!=0||this.year%400==0?1:0;0==this.day&&(1==this.month?(this.month=12,this.year--):this.month--,this.day=this.days[this.month][e]),this.drawElements()}}),EventCal=function(e,t,s,i,r){this.init(e,t,s,i,r)},$.extend(EventCal.prototype,{resourceId:"",eventId:"",startDay:"",endDay:"",label:"",jObject:null,init:function(e,t,s,i,r){this.resourceId=e,this.eventId=t,this.startDay=s,this.endDay=i,this.label=r},drawIn:function(e){var t,s,i=0,r=0;if(containerId=e.container,"MONTH"==e.TimeLineClass)i=e.cellWidth*(this.startDay-1),r=e.cellWidth*(this.endDay-this.startDay)-3;else if("WEEK"==e.TimeLineClass)t=this.startDay-e.mondayOfWeek.getDate(),s=this.endDay-e.mondayOfWeek.getDate(),i=e.cellWidth*t,r=e.cellWidth*(s-t)-3;else if("DAY"==e.TimeLineClass){var n=this.startDay-e.startHour(),a=this.endDay-e.startHour();i=e.cellWidth*n,r=e.cellWidth*(a-n)-3}return e.addEvent(this),$("#"+containerId).find("#events_r_"+this.resourceId).append('<div id="'+this.eventId+'" class="event" style="left: '+i+"px;width:"+r+'px;">'+this.label+"</div>"),this.jObject=$("#"+this.eventId),$("#"+containerId).find("#"+this.eventId).draggable({axis:"x",containment:"parent",opacity:.5,snap:!0}),$("#"+containerId).find("#events_r_"+this.resourceId).droppable({drop:function(t,s){var i,r,n;i=$(this).offset().left,r=s.offset.left,n=1+(r-i)/e.cellWidth,$(".debug").html("newDayStart: "+n)}}),this},asVector:function(e){var t;return"MONTH"==e.TimeLineClass?t=new Vector(this.startDay-1,this.endDay-this.startDay):"WEEK"==e.TimeLineClass?(newStartDay=this.startDay-e.mondayOfWeek.getDate(),newEndDay=this.endDay-e.mondayOfWeek.getDate(),t=new Vector(2*newStartDay,2*(newEndDay-newStartDay))):"DAY"==e.TimeLineClass&&(newStartDay=this.startDay-e.startHour(),newEndDay=this.endDay-e.startHour(),t=new Vector(newStartDay,newEndDay-newStartDay)),t}});
