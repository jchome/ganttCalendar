/*
 * Gantt Calendar by Julien CORON - 2013
 * Copyright 2013 Julien CORON
 * 
 * Licence :
   Ce programme est un logiciel libre ; vous pouvez le redistribuer ou le 
   modifier suivant les termes de la GNU General Public License telle que 
   publiée par la Free Software Foundation ; soit la version 3 de la licence, 
   soit (à votre gré) toute version ultérieure.

   Ce programme est distribué dans l'espoir qu'il sera utile, mais SANS AUCUNE 
   GARANTIE ; pas même la garantie implicite de COMMERCIABILISABILITÉ ni 
   d'ADÉQUATION à UN OBJECTIF PARTICULIER. Consultez la GNU General Public 
   License pour plus de détails.
 * 
 * 
   This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

TimeLine=function(e,t,n,r,s){var i=this.init(e,t,n,r,s);return $(window).resize(function(){i.drawElements(),i.updateCallback(),this.updateOccupation()}),i},$.extend(TimeLine.prototype,{TimeLineClass:null,container:"",year:"",weekDays:{fr:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],en:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},days:{1:[31,31],2:[28,29],3:[31,31],4:[30,30],5:[31,31],6:[30,30],7:[31,31],8:[31,31],9:[30,30],10:[31,31],11:[30,30],12:[31,31]},months:{fr:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Décembre"],en:["January","February","March","April","May","June","July","Agust","September","October","November","December"]},eventsByGroup:{},eventsByResource:{},cellWidth:20,lang:"fr",resourcesColumnHeader:{fr:"Ressources",en:"Resources"},init:function(e,t,n,r,s){return this.container=e,this.year=n,this.resources=r,this.updateCallback=s||function(){},this.sub_init(t),this},sub_init:function(){},nbDays:function(){return 0},nbSteps:function(){return 0},firstDay:function(){return 0},findGroupHavingResource:function(e){for(var t=0;t<this.resources.groups.length;t++)for(var n=this.resources.groups[t],r=0;r<n.resources.length;r++){var s=n.resources[r];if(s.id==e)return n}return null},_drawResourcesIn:function(e,t){for(null==t&&(t=!1),calendarHeaders=$(document.createElement("div")).addClass("leftColumn horizontalCalendarHeaders"),e.append(calendarHeaders),headerResources=$(document.createElement("div")).addClass("headerResources"),calendarHeaders.html(headerResources),listResources=$(document.createElement("div")).addClass("listResources"),calendarHeaders.append(listResources),indexGroup=0;indexGroup<this.resources.groups.length;indexGroup++)for(group=this.resources.groups[indexGroup],listResources.append('<div id="group_'+group.id+'_left" class="group_left" data-group="'+group.id+'">					<span class="toggleImg">&#9660;</span><span class="labelLeft">'+group.name+"</span>				</div>"),groupResources=$(document.createElement("div")).addClass("resourcesForGroup").attr("id","resourcesForGroup_"+group.id).data("group",group.id),listResources.append(groupResources),indexResource=0;indexResource<group.resources.length;indexResource++)resource=group.resources[indexResource],groupResources.append('<div id="resource_'+resource.id+'" data-group="group_'+group.id+'" class="resource lineResource">					<span class="labelRight">'+resource.name+"</span>					</div>");return headerResources},_prepareDrawings:function(){return this.eventsByGroup={},this.eventsByResource={},this.containerObj=$("#"+this.container),this.containerObj.timeLineMonth=this,largeCalendar=$(document.createElement("div")).addClass("largeCalendar"),this.containerObj.html(largeCalendar),largeCalendar},_setZoomFeatures:function(e,t,n){this.containerObj.width($("body").outerWidth()-1);var r=this.nbDays();this.cellWidth*r+t.width()+3<this.containerObj.width()&&this.containerObj.width(this.cellWidth*r+t.width()+3);var s=e.width()-t.width()-1;this.cellWidth*r<s&&(s=this.cellWidth*r),n.width(s)},_drawGridEvents:function(e){var t=$(document.createElement("div")).addClass("eventsAndGroupContainer");for(e.append(t),indexGroup=0;indexGroup<this.resources.groups.length;indexGroup++)for(group=this.resources.groups[indexGroup],t.append('<div id="group_'+group.id+'_right"data-group="'+group.id+'" class="group_right">&nbsp;</div>'),groupResources=$(document.createElement("div")).addClass("eventsForGroup").attr("id","eventsForGroup_"+group.id).data("group",group.id),t.append(groupResources),indexResource=0;indexResource<group.resources.length;indexResource++)resource=group.resources[indexResource],groupResources.append('<div class="lineForResource grid-'+this.cellWidth+"-offset-"+this.mondayPosition()+'" data-resource="resource_'+resource.id+'" id="events_r_'+resource.id+'"></div>')},addEvent:function(e){var t=this.findGroupHavingResource(e.resourceId);null==t&&alert("Error: Event id="+e.eventId+" has an error. Please check resourceId."),null==this.eventsByGroup[t.id]&&(this.eventsByGroup[t.id]=Array()),this.eventsByGroup[t.id].push(e),null==this.eventsByResource[e.resourceId]&&(this.eventsByResource[e.resourceId]=Array()),this.eventsByResource[e.resourceId].push(e)},updateOccupation:function(){for(var e,t,n=this,r=this.nbSteps(),s=0;s<this.resources.groups.length;s++){var i=this.resources.groups[s];if(null!=this.eventsByGroup[i.id]){var a=$("#group_"+i.id+"_right"),o=this.eventsByGroup[i.id],d=$.map(o||[],function(e){return e.asVector(n)});e=Vector.mergeContinuous(d),Vector.flatDisplay(e,a,0,r,"occupationLeak");for(var d=Array(),u=0;u<i.resources.length;u++){var c=i.resources[u],h=this.eventsByResource[c.id],l=$.map(h||[],function(e){return e.asVector(n)});d.push(l)}t=Vector.intersectAll(d),Vector.flatDisplay(t,a,0,r,"occupationFull")}}for(resource_id in this.eventsByResource){var p=0,o=this.eventsByResource[resource_id],d=$.map(o||[],function(e){return e.asVector(n)});if(p=Vector.countOverlaps(d),$("#resource_"+resource_id).addClass("overlap_"+p),$("#events_r_"+resource_id).addClass("overlap_"+p),p>1)for(var m,g=1,v=d[0],f=1;f<d.length;f++)m=v.intersection(d[f]),0!=m.getLength()&&($("#"+o[f].eventId).css("top",1+24*g+"px"),g++)}},closeGroup:function(e){$("#resourcesForGroup_"+e).animate({height:"toggle"}),$("#eventsForGroup_"+e).animate({height:"toggle"});var t=$("#group_"+e+"_left > .toggleImg");t.html("1px"==$("#resourcesForGroup_"+e).css("height")?"&#9660;":"&#9654;")},defineHeader:function(){this.header=this.containerObj.clone().attr("id","headerCalendar"),this.header.find(".listResources").remove(),this.header.find(".eventsAndGroupContainer").remove(),this.header.hide(),this.containerObj.append(this.header)},updateScrollWindow:function(){var e=this.containerObj.offset(),t=$(window).scrollTop(),n=this.header.height();t>e.top&&t<e.top+this.containerObj.height()-n?(this.header.show(),this.header.css("top",$(window).scrollTop())):this.header.hide()}}),TimeLineMonth=function(e,t,n,r,s){return this.init(e,t,n,r,s)},TimeLineMonth.prototype=Object.create(TimeLine.prototype),$.extend(TimeLineMonth.prototype,{TimeLineClass:"MONTH",month:"",sub_init:function(e){this.month=e},nbDays:function(){var e=this.year%4==0&&this.year%100!=0||this.year%400==0?1:0;return this.days[this.month][e]},nbSteps:function(){return this.nbDays()},mondayPosition:function(){return new Date(this.year,this.month-1,1).getDay()},drawElements:function(){var e,t,n,r,s,i,a,o,d,u,e=this._prepareDrawings();t=$(document.createElement("div")).addClass("month"),e.html(t),t.html('<div class="prevMonth" title="[Page down] Go to Previous month"></div>		<div class="nameMonth">'+this.months[this.lang][this.month-1]+" "+this.year+'</div>		<div class="nextMonth" id="nextMonth" title="[Page up] Go to next month"></div>');var r=this._drawResourcesIn(e);for(n=$(document.createElement("div")).addClass("eventsContainer container-grid-"+this.cellWidth),e.append(n),this._setZoomFeatures(e,r,n),s=$(document.createElement("span")).addClass("labelCenter").html(this.resourcesColumnHeader[this.lang]),r.html(s),i=$(document.createElement("div")).addClass("horizontalCalendarContent for"+this.nbDays()+"days").attr("tabindex","0"),n.append(i),a=$(document.createElement("div")).addClass("lineOfDays"),i.html(a),o="",d=1;d<=this.nbDays();d++)u=10>d?"0"+d:d,jsDate=new Date(this.year,this.month-1,d),o+='<div class="day weekdayorder_'+jsDate.getDay()+'" id="day_'+u+'">'+u+'<br/><span class="weekDay">'+this.weekDays[this.lang][jsDate.getDay()]+"</span></div>";a.html(o),this._drawGridEvents(i),this.defineEvents(),this.updateCallback(),this.updateOccupation(),this.defineHeader()},drawHeaderResources:function(){},goToNextMonth:function(){12==this.month?(this.month=1,this.year++):this.month++,this.drawElements()},goToPrevMonth:function(){1==this.month?(this.month=12,this.year--):this.month--,this.drawElements()},updateWidth:function(){$(".eventsContainer").width($(".largeCalendar").width()-$(".headerResources").width()-1)},defineEvents:function(){var e=this;$(".prevMonth").click(function(){e.goToPrevMonth()}),$(".nextMonth").click(function(){e.goToNextMonth()}),$(".horizontalCalendarContent").keydown(function(t){switch(t.keyCode){case 34:e.goToPrevMonth(),$(".horizontalCalendarContent").focus();break;case 33:e.goToNextMonth(),$(".horizontalCalendarContent").focus()}}),$(".group_left").click(function(){e.closeGroup($(this).attr("data-group"))}),$(window).scroll(function(){e.updateScrollWindow()})}}),TimeLineWeek=function(e,t,n,r,s){return this.init(e,t,n,r,s)},TimeLineWeek.prototype=Object.create(TimeLine.prototype),$.extend(TimeLineWeek.prototype,{TimeLineClass:"WEEK",weekNumber:"",mondayOfWeek:null,sundayOfWeek:null,sub_init:function(e){this.weekNumber=e},dateFormat:function(){var e=this.weekDays[this.lang][1],t=this.weekDays[this.lang][0],n={year:"numeric",month:"2-digit",day:"2-digit"};return e+" "+this.mondayOfWeek.toLocaleDateString(this.lang,n)+" - "+t+" "+this.sundayOfWeek.toLocaleDateString(this.lang,n)},nbDays:function(){return 7},nbSteps:function(){return 13},mondayPosition:function(){return new Date(this.mondayOfWeek.getTime()).getDay()},drawElements:function(){var e,t,n,r,s,i,a,o,d,u,c=new Date(this.year,0,1),h=6048e5*(this.weekNumber-1),l=c.getTime()+h-864e5;this.mondayOfWeek=new Date(l),this.sundayOfWeek=new Date(l),this.sundayOfWeek.setDate(this.mondayOfWeek.getDate()+6);var e=this._prepareDrawings();t=$(document.createElement("div")).addClass("week"),e.html(t),t.html('<div class="prevWeek" title="[Page down] Go to Previous week"></div>		<div class="nameWeek"> '+this.dateFormat()+'</div>		<div class="nextWeek" id="nextWeek" title="[Page up] Go to next week"></div>');var r=this._drawResourcesIn(e);n=$(document.createElement("div")).addClass("eventsContainer container-grid-"+this.cellWidth+" forWeek"),e.append(n),this._setZoomFeatures(e,r,n),s=$(document.createElement("span")).addClass("labelCenter").html(this.resourcesColumnHeader[this.lang]),r.html(s),i=$(document.createElement("div")).addClass("horizontalCalendarContent").attr("tabindex","0").width(7*this.cellWidth),n.append(i),a=$(document.createElement("div")).addClass("lineOfDays"),i.html(a),o="";var p=new Date(this.mondayOfWeek.getTime());for(d=1;7>=d;d++)u=p.getDate()<10?"0"+p.getDate():p.getDate(),o+='<div class="day weekdayorder_'+p.getDay()+'" id="day_'+u+'">'+u+'<br/><span class="weekDay">'+this.weekDays[this.lang][d%7]+"</span></div>",p.setDate(p.getDate()+1);a.html(o),this._drawGridEvents(i),this.defineEvents(),this.updateCallback(),this.updateOccupation(),this.defineHeader()},goToNextWeek:function(){52==this.weekNumber?(this.weekNumber=1,this.year++):this.weekNumber++,this.drawElements()},goToPrevWeek:function(){1==this.weekNumber?(this.weekNumber=52,this.year--):this.weekNumber--,this.drawElements()},updateWidth:function(){$(".eventsContainer").width($(".largeCalendar").width()-$(".headerResources").width()-1)},defineEvents:function(){calendarObject=this,$(".prevWeek").click(function(){calendarObject.goToPrevWeek()}),$(".nextWeek").click(function(){calendarObject.goToNextWeek()}),$(".horizontalCalendarContent").keydown(function(e){switch(e.keyCode){case 34:calendarObject.goToPrevWeek(),$(".horizontalCalendarContent").focus();break;case 33:calendarObject.goToNextWeek(),$(".horizontalCalendarContent").focus()}}),$(".group_left").click(function(){calendarObject.closeGroup($(this).attr("data-group"))}),$(window).scroll(function(){calendarObject.updateScrollWindow()})}}),EventCal=function(e,t,n,r,s){this.init(e,t,n,r,s)},$.extend(EventCal.prototype,{resourceId:"",eventId:"",startDay:"",endDay:"",label:"",jObject:null,init:function(e,t,n,r,s){this.resourceId=e,this.eventId=t,this.startDay=n,this.endDay=r,this.label=s},drawIn:function(e){var t,n,r=0,s=0;return containerId=e.container,"MONTH"==e.TimeLineClass?(r=e.cellWidth*(this.startDay-1),s=e.cellWidth*(this.endDay-this.startDay)-3):"WEEK"==e.TimeLineClass&&(t=this.startDay-e.mondayOfWeek.getDate(),n=this.endDay-e.mondayOfWeek.getDate(),r=e.cellWidth*t,s=e.cellWidth*(n-t)-3),e.addEvent(this),$("#"+containerId).find("#events_r_"+this.resourceId).append('<div id="'+this.eventId+'" class="event" style="left: '+r+"px;width:"+s+'px;">'+this.label+"</div>"),this.jObject=$("#"+this.eventId),$("#"+containerId).find("#"+this.eventId).draggable({axis:"x",containment:"parent",opacity:.5,snap:!0}),$("#"+containerId).find("#events_r_"+this.resourceId).droppable({drop:function(t,n){var r,s,i;r=$(this).offset().left,s=n.offset.left,i=1+(s-r)/e.cellWidth,$(".debug").html("newDayStart: "+i)}}),this},asVector:function(e){var t;return"MONTH"==e.TimeLineClass?t=new Vector(this.startDay-1,this.endDay-this.startDay):"WEEK"==e.TimeLineClass&&(newStartDay=this.startDay-e.mondayOfWeek.getDate(),newEndDay=this.endDay-e.mondayOfWeek.getDate(),t=new Vector(2*newStartDay,2*(newEndDay-newStartDay))),t}});
